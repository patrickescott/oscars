<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    </head>
    <body>
        <style>
            body{
                background: #E6E6E6;

            }
            .chart{
                background: black;
                width: 100%;
                height: 500px;
            }
            .chart svg{
                background: #E6E6E6;
            }

            .d3-tip {
                line-height: 1;
                font-size: 0.6em;
                padding: 5px;
                background: rgba(70, 130, 180, 0.9);
                color: rgb(255,255,255);
                border-radius: 2px;
            }

            h2 {
                color: black;
                text-align: center;
                font-size: 1.2em;
            }

            h3 {
                color: black;
                text-align: center;
                font-size: 0.7em;
            }

            .axis {
                font-size: 0.6em;
            }

            text {
                font-size: 1em;
            }

            path {
                fill: none;
                stroke: black;
                stroke-width: 2px;
            }

            .tick {
                fill: none;
                stroke: black;
            }

            circle {
                opacity: 0.4;
                stroke: none;
            }

            .line_plot {
                fill: none;
                stroke: #4eb0bb;
                stroke-width: 1px;
            }

        </style>
        <h2>Oscars Best Picture Nominees by Production Budget</h2>
        <div class='chart'></div>
        <script type="text/javascript">
            var graphic = function (csvFile) {
                var main = this;
                var mainData,
                        format = d3.time.format("%Y");
                var chartEl = d3.select('.chart');
                var margin = {top: 30, right: 30, bottom: 30, left: 30};
                var width, height, intervals, radius, multiplier;
                var count_extent, svg, time_extent, time_scale, count_scale, time_axis, count_axis, legend;

                d3.csv(csvFile, function (d) {
                    d['Budget $'] = +d["Budget $"];
                    d['Year'] = format.parse(d['Year']);
                    d['takings'] = +d['takings'];
                    d['First Month'] = +d['First Month'];
                    return d
                }, function (d) {
                    mainData = d;
                    start(mainData)
                });
                var start = function () {
                    updateSizes();
                    // Use d3 to create svg and then append g for chart
                    svg = d3.select("div")
                            .append("svg")
                            //.attr("width", width + margin.left + margin.right)
                            //.attr("height", height + margin.top + margin.bottom)
                            .attr("width", width)
                            .attr("height", height)
                            .append('g')
                            .attr('class', 'chart');
                    d3.select('svg')
                            .selectAll("circle")
                            .data(mainData)
                            .enter()
                            .append("circle")


                    d3.select("svg")
                            .append('g')
                            .attr('class', 'x axis')
                            .attr('transform', "translate(0," + (height - margin.bottom - margin.top) + ")")
                            .call(time_axis);

                    // Creates y-axis
                    count_axis = d3.svg.axis()
                            .scale(count_scale)
                            .orient("left");

                    d3.select("svg")
                            .append('g')
                            .attr('class', 'y axis')
                            .attr('transform', "translate(" + margin.left + ",0)")
                            .call(count_axis)
                            .append('text')
                            .attr('transform', 'rotate(-90)')
                            .attr('x', -margin.left)
                            .attr('y', 6)
                            .attr('dy', ".71em")
                            .style("text-anchor", "end")
                            .text("Production Budget Millions $");

                    // Creates tooltip
                    var tip = d3.tip()
                            .attr('class', 'd3-tip')
                            .offset([-5, 0])
                            .html(function (d) {
                                return "<strong>" + d['Film'] + "</strong> <br/>"
                                        + d['Outcome'] + ' in ' + d['Year2'] + "<br/>"
                                        + "Production Budget: $" + d['Budget $'] + "m<br/>"
                                        + "First Month's Takings: $" + d['First Month'] + "m"
                            });

                    // Plots circles
                    d3.selectAll('circle')
                            .attr('class','bubble')
                            .attr('cx', function (d) {
                                return time_scale(d['Year']);
                            })
                            .attr('cy', function (d) {
                                return count_scale(d['Budget $']);
                            })
                            // Changes r and fill colour depending on specified criteria
                            .attr('r', function (d) {
                                return Math.sqrt(d['takings']) * width / 100;
                            })
                            .attr('fill', function (d) {
                                if (d['Outcome'] === 'Winner') {
                                    return 'red';
                                } else {
                                    return 'steelblue';
                                }
                            })
                            .call(tip)
                            .on('mouseover', tip.show)
                            .on('mouseout', tip.hide);

                    // Adds legend
                    legend = svg.append("g")
                            .attr("class", "legend")
                            .attr("transform", "translate(" + (margin.left * 2) + "," + (margin.top * 1.5) + ")")
                            .selectAll("g")
                            .data(["Winner", "Nominee"])
                            .enter().append("g");

                    legend.append("circle")
                            .attr("cy", function (d, i) {
                                console.log("d"+d)
                                console.log("i"+i)
                                return i * 30;
                            })
                            .attr("r", function (d) {
                                return radius + 2;
                            })
                            .attr("fill", function (d) {
                                if (d == "Winner") {
                                    return 'red';
                                } else {
                                    return 'steelblue';
                                }
                            })

                    legend.append("text")
                            .attr("y", function (d, i) {
                                return i * 30 + 5;
                            })
                            .attr("x", radius * 5)
                            .text(function (d) {
                                return d;
                            });
                };

                var updateSizes = function () {
                    width = parseInt(chartEl.style('width'), 10);
                    height = parseInt(chartEl.style('height'), 10);
                    intervals = 1;

                    if (width < 500) {
                        intervals = 2;
                    }
                    radius = 4;
                    multiplier = 2;

                    chartEl.select("svg").attr("width", width)
                            .attr("height", height)
                    time_extent = d3.extent(mainData, function (d) {
                        return d['Year'];
                    });

                    time_scale = d3.time.scale()
                            .range([margin.left, width - margin.left])
                            .domain(time_extent);

                    // Determines scale for y axis
                    count_extent = d3.extent(mainData, function (d) {
                        return d['Budget $'];
                    });
                    count_scale = d3.scale.linear()
                            .range([height - margin.bottom - margin.top, margin.top])
                            .domain(count_extent);

                    // Creates x-axis
                    time_axis = d3.svg.axis()
                            .scale(time_scale)
                            .ticks(d3.time.years, intervals);
                            
                };
                d3.select(window).on('resize', function () {
                    if (main.resizeTO) {
                        clearTimeout(main.resizeTO);
                    }
                    main.resizeTO = setTimeout(function () {
                        main.redraw();
                    }, 150);
                });
                d3.select(window).on("resizeEnd", function () {
                    main.redraw();
                });
                this.redraw = function () {
                    updateSizes();

                    d3.selectAll('circle.bubble')
                            .attr('cx', function (d) {
                                return time_scale(d['Year']);
                            })
                            .attr('cy', function (d) {
                                return count_scale(d['Budget $']);
                            })
                             .attr('r', function(d) {
                                return Math.sqrt(d['takings']) * width/100;
                            })
                            .attr('fill', function(d) {
                                if (d['Outcome'] === 'Winner')  {
                                    return 'red';
                                } else {
                                    return 'steelblue';
                                }
                            })
                };
                // draw(mainData);
            }


            var myGraphic = new graphic("oscars.csv");
            //myGraphic.jump("dd")
        </script>
    </body>
</html>
